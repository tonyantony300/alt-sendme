name: Lint & Format CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint:
    name: Linting `web-app` codebase
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
      - name: Install dependencies
        run: npm install
      - name: Run lint script
        run: npm run lint
      - name: Run format script
        run: npm run lint:fix && npm run format

  lockfiles-check:
    name: Reject lockfile-only changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Ensure lockfiles are not changed without manifest changes
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          CHANGED=$(git diff --name-only "$BASE"...HEAD)
          fail() { echo "::error::$1"; exit 1; }
          if echo "$CHANGED" | grep -q '^package-lock\.json$'; then
            echo "$CHANGED" | grep -q '^package\.json$' || fail "package-lock.json was modified but package.json was not. Only change package-lock.json when you add/update dependencies in package.json. To discard: git checkout origin/main -- package-lock.json"
          fi
          if echo "$CHANGED" | grep -q '^src-tauri/Cargo\.lock$'; then
            echo "$CHANGED" | grep -q '^src-tauri/Cargo\.toml$' || fail "src-tauri/Cargo.lock was modified but src-tauri/Cargo.toml was not. Only change Cargo.lock when you add/update dependencies in Cargo.toml. To discard: git checkout origin/main -- src-tauri/Cargo.lock"
          fi
          if echo "$CHANGED" | grep -q '^sendme/Cargo\.lock$'; then
            echo "$CHANGED" | grep -q '^sendme/Cargo\.toml$' || fail "sendme/Cargo.lock was modified but sendme/Cargo.toml was not. Only change Cargo.lock when you add/update dependencies in Cargo.toml. To discard: git checkout origin/main -- sendme/Cargo.lock"
          fi
          echo "Lockfiles check passed."
